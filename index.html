import React, { useState, useEffect, useRef } from 'react';
import { Settings, RotateCw, Mic, MicOff, AlertTriangle, Bell, ExternalLink } from 'lucide-react';

// --- Sound Engine ---
let audioCtx = null;
const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); };

const playSynth = (type) => {
  if (!audioCtx) return;
  try {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    
    if (type === 'wake') {
      osc.type = 'sine'; osc.frequency.setValueAtTime(250, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.3);
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
      osc.start(); osc.stop(audioCtx.currentTime + 0.3);
    } else if (type === 'angry') {
      osc.type = 'sawtooth'; osc.frequency.setValueAtTime(120, audioCtx.currentTime);
      osc.frequency.linearRampToValueAtTime(40, audioCtx.currentTime + 0.4);
      gain.gain.setValueAtTime(0.15, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.4);
      osc.start(); osc.stop(audioCtx.currentTime + 0.4);
    } else if (type === 'pet') {
      osc.type = 'sine'; osc.frequency.setValueAtTime(500, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.05, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
      osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }
  } catch (e) {}
};

const App = () => {
  const [isLandscape, setIsLandscape] = useState(window.innerWidth > window.innerHeight);
  const [isAsleep, setIsAsleep] = useState(true);
  const [mood, setMood] = useState('neutral');
  const [idleAction, setIdleAction] = useState(null);
  const [eyePos, setEyePos] = useState({ x: 0, y: 0 });
  const [showSettings, setShowSettings] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [isListening, setIsListening] = useState(false);
  const [isWakewordActive, setIsWakewordActive] = useState(false);
  const [localKey, setLocalKey] = useState(localStorage.getItem('mimo_key') || "");
  const [preloadedAudio, setPreloadedAudio] = useState({});
  const [syncProgress, setSyncProgress] = useState(0);
  const [isSyncing, setIsSyncing] = useState(false);
  const [showSkip, setShowSkip] = useState(false);
  const [isBypassed, setIsBypassed] = useState(false);

  const recognitionRef = useRef(null);
  const syncTimer = useRef(null);
  const petX = useRef(0);
  const lastState = useRef({ isAsleep: true, isLandscape: window.innerWidth > window.innerHeight });

  useEffect(() => {
    const handleResize = () => {
      const l = window.innerWidth > window.innerHeight;
      if (!l && lastState.current.isLandscape && !lastState.current.isAsleep) {
        playSynth('angry');
        setMood('angry');
        triggerSpeech("Rotate me back! I was busy!", 'rotateWarn');
      }
      setIsLandscape(l);
      lastState.current.isLandscape = l;
    };
    window.addEventListener('resize', handleResize);
    if (localKey) preloadAssets(localKey);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  const pcmToWav = (pcm, rate) => {
    const buf = new ArrayBuffer(44 + pcm.length * 2);
    const view = new DataView(buf);
    const s = (o, str) => { for (let i = 0; i < str.length; i++) view.setUint8(o + i, str.charCodeAt(i)); };
    s(0, 'RIFF'); view.setUint32(4, 32 + pcm.length * 2, true); s(8, 'WAVE'); s(12, 'fmt ');
    view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
    view.setUint32(24, rate, true); view.setUint32(28, rate * 2, true);
    view.setUint16(32, 2, true); view.setUint16(34, 16, true); s(36, 'data');
    view.setUint32(40, pcm.length * 2, true);
    for (let i = 0, o = 44; i < pcm.length; i++, o += 2) view.setInt16(o, pcm[i], true);
    return buf;
  };

  const preloadAssets = async (key) => {
    if (!key || isSyncing) return;
    setIsSyncing(true);
    setSyncProgress(5);
    setShowSkip(false);

    syncTimer.current = setTimeout(() => {
      setShowSkip(true);
    }, 30000);

    const phrases = [
      { id: 'rotateWarn', text: "Rotate me back! I was busy!" },
      { id: 'settingsWarn', text: "Hey! What are you doing with me?!" },
      { id: 'busyWarn', text: "Stop it! I was busy!" },
      { id: 'snore', text: "Zzz... honk shoo..." }
    ];
    
    const loaded = {};
    try {
      for (let i = 0; i < phrases.length; i++) {
        const item = phrases[i];
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: item.text }] }],
            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } }
          })
        }).then(r => r.json());
        const data = res.candidates[0].content.parts[0].inlineData;
        loaded[item.id] = URL.createObjectURL(new Blob([pcmToWav(new Int16Array(Uint8Array.from(atob(data.data), c => c.charCodeAt(0)).buffer), 24000)], { type: 'audio/wav' }));
        setSyncProgress(((i + 1) / phrases.length) * 100);
      }
      setPreloadedAudio(loaded);
      setIsSyncing(false);
      clearTimeout(syncTimer.current);
    } catch (e) {
      console.error("Background sync partially failed or key invalid.");
      setIsSyncing(false);
    }
  };

  const triggerSpeech = async (text, id = null) => {
    if (id && preloadedAudio[id]) {
      setIsSpeaking(true);
      const a = new Audio(preloadedAudio[id]);
      a.onended = () => { setIsSpeaking(false); setMood('neutral'); if (isWakewordActive) startRecognition(); };
      a.play();
      return;
    }
    if (!localKey || isSpeaking) return;
    setIsSpeaking(true);
    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${localKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text }] }],
          generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } }
        })
      }).then(r => r.json());
      const data = res.candidates[0].content.parts[0].inlineData;
      const audio = new Audio(URL.createObjectURL(new Blob([pcmToWav(new Int16Array(Uint8Array.from(atob(data.data), c => c.charCodeAt(0)).buffer), 24000)], { type: 'audio/wav' })));
      audio.onended = () => { setIsSpeaking(false); setMood('neutral'); if (isWakewordActive) startRecognition(); };
      audio.play();
    } catch (e) { setIsSpeaking(false); }
  };

  const startRecognition = () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return;
    recognitionRef.current = new SR();
    recognitionRef.current.continuous = true;
    recognitionRef.current.lang = 'en-US';
    recognitionRef.current.onstart = () => setIsWakewordActive(true);
    recognitionRef.current.onresult = (event) => {
      const t = event.results[event.results.length - 1][0].transcript.toLowerCase();
      const triggers = ["mimo", "memo", "mymo", "meemo", "hey mimo", "hi mimo"];
      let m = triggers.find(tr => t.includes(tr));
      if (m) {
        const q = t.split(m)[1]?.trim();
        if (q && q.length > 1) handleConversation(q);
        else { setMood('neutral'); setIsListening(true); setTimeout(() => setIsListening(false), 3000); }
      }
    };
    try { recognitionRef.current.start(); } catch(e) {}
  };

  const stopRecognition = () => { setIsWakewordActive(false); if (recognitionRef.current) recognitionRef.current.stop(); };

  const handleConversation = async (query) => {
    if (isSpeaking) return;
    setIsListening(true);
    if (recognitionRef.current) recognitionRef.current.stop();
    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${localKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: query }] }],
          systemInstruction: { parts: [{ text: "You are MIMO. Puck voice robot. Cute. Responses < 15 words." }] }
        })
      }).then(r => r.json());
      const text = res.candidates?.[0]?.content?.parts?.[0]?.text;
      if (text) { setMood('happy'); setIsListening(false); await triggerSpeech(text); }
    } catch (e) { setIsListening(false); if (isWakewordActive) startRecognition(); }
  };

  const handleInteraction = () => {
    initAudio();
    if (Notification.permission === 'default') Notification.requestPermission();
    if (isAsleep) {
      playSynth('wake'); setIsAsleep(false); lastState.current.isAsleep = false;
    } else {
      setEyePos({ x: (Math.random() - 0.5) * 60, y: (Math.random() - 0.5) * 30 });
    }
  };

  const forceBypass = (e) => {
    e.stopPropagation();
    setIsBypassed(true);
  };

  return (
    <div className="w-full h-screen bg-black flex items-center justify-center overflow-hidden relative font-mono text-white select-none" onClick={handleInteraction}>
      {/* LOADING SCREEN (Only if not bypassed and currently syncing) */}
      {!isLandscape && !isBypassed && isSyncing ? (
        <div className="flex flex-col items-center justify-center h-full p-8 text-center bg-[#080808] w-full animate-in fade-in zoom-in duration-500">
          <RotateCw className="w-12 h-12 text-cyan-500 animate-spin mb-10" />
          <h1 className="text-2xl font-black tracking-widest uppercase mb-4 italic">Initialize MIMO</h1>
          <div className="w-48 h-1.5 bg-zinc-900 rounded-full overflow-hidden border border-zinc-800 mb-6 shadow-inner">
            <div className="h-full bg-cyan-500 shadow-[0_0_15px_cyan]" style={{ width: `${syncProgress}%`, transition: 'width 0.5s' }} />
          </div>
          <p className="text-zinc-600 text-[10px] uppercase tracking-[0.4em] mb-12 animate-pulse">Syncing Neural Core...</p>
          
          {showSkip && (
            <button onClick={forceBypass} className="px-8 py-3 bg-zinc-900 border border-zinc-800 text-[10px] text-cyan-500/80 uppercase tracking-widest rounded-full flex items-center gap-2 hover:bg-zinc-800 active:scale-95 transition-all shadow-lg">
              <AlertTriangle size={14} /> Force Bypass
            </button>
          )}
        </div>
      ) : !isLandscape ? (
        <div className="flex flex-col items-center justify-center h-full p-8 text-center bg-[#050505] w-full">
          <RotateCw className="w-10 h-10 text-zinc-800 mb-8" />
          <h1 className="text-2xl font-bold tracking-tighter uppercase mb-2 opacity-30">Link Offline</h1>
          <p className="text-zinc-700 text-[9px] uppercase tracking-[0.3em]">Rotate device to connect</p>
        </div>
      ) : (
        <>
          <div className="scanline" />
          
          {/* Petting Zone */}
          <div className="absolute top-0 left-0 w-full h-16 z-[50]"
            onMouseDown={(e) => petX.current = e.clientX}
            onMouseMove={(e) => {
              if (isAsleep || idleAction) return;
              if (Math.abs(e.clientX - petX.current) > 60) { setMood('happy'); playSynth('pet'); petX.current = e.clientX; setTimeout(() => setMood('neutral'), 2000); }
            }}
          />

          <button onClick={(e) => { e.stopPropagation(); initAudio(); setShowSettings(true); triggerSpeech("What are you doing with me?!", 'settingsWarn'); setMood('angry'); }} className="absolute top-6 right-6 p-4 text-zinc-700 z-[100] hover:text-cyan-400 transition-all"><Settings /></button>
          
          <div className="absolute top-8 left-8 flex flex-col gap-3 z-10">
            <div className="flex flex-col gap-1">
              <div className="text-[10px] text-cyan-500 font-bold uppercase tracking-widest">MIMO-OS_v9.9</div>
              <div className={`w-2 h-2 rounded-full ${isAsleep ? 'bg-zinc-800' : 'bg-cyan-500 animate-pulse shadow-[0_0_8px_cyan]'}`} />
            </div>
            
            {/* HUD Loading Bar (only if sync isn't done) */}
            {syncProgress < 100 && (
              <div className="flex flex-col gap-1">
                <div className="w-24 h-1 bg-zinc-900 rounded-full overflow-hidden border border-zinc-800 shadow-inner">
                  <div className="h-full bg-cyan-500/50 shadow-[0_0_5px_cyan]" style={{ width: `${syncProgress}%`, transition: 'width 0.8s' }} />
                </div>
                <span className="text-[7px] text-zinc-700 uppercase tracking-tighter">Memory Syncing...</span>
              </div>
            )}
          </div>

          <div className="relative flex items-center justify-center transition-transform duration-700" style={{ transform: `translate(${eyePos.x}px, ${eyePos.y}px)` }}>
            <div className={`flex gap-24 md:gap-40 items-center justify-center transition-all duration-1000 ${isAsleep ? 'scale-[0.85]' : 'scale-100'}`}>
              <Eye mood={mood} isAsleep={isAsleep} isSpeaking={isSpeaking} />
              <Eye mood={mood} isAsleep={isAsleep} isSpeaking={isSpeaking} />
            </div>
          </div>

          <div className="absolute bottom-12 text-[7px] text-zinc-800 tracking-[0.5em] uppercase font-bold text-center">
            {isAsleep ? "Touch to Wake" : mood === 'angry' ? "DIRECT INTERFERENCE" : "Say 'Hey Mimo'"}
          </div>

          {!isAsleep && (
            <button onClick={(e) => { e.stopPropagation(); isWakewordActive ? stopRecognition() : startRecognition(); }} className={`absolute bottom-8 left-8 p-5 rounded-full z-[100] transition-all shadow-xl ${isWakewordActive ? 'bg-cyan-500 text-black shadow-cyan-500/20' : 'bg-zinc-900 text-zinc-500 border border-zinc-800'}`}>
              {isWakewordActive ? <Mic size={24} /> : <MicOff size={24} />}
            </button>
          )}

          {showSettings && (
            <div className="absolute inset-0 bg-black/95 z-[2000] flex items-center justify-center p-6 animate-in fade-in duration-300" onClick={(e) => e.stopPropagation()}>
              <div className="w-full max-w-sm border border-zinc-800 bg-zinc-950 p-10 rounded-3xl shadow-[0_0_50px_rgba(0,0,0,0.5)] border-t-cyan-900/30">
                <h2 className="text-lg font-black tracking-widest text-cyan-500 uppercase mb-6 text-center italic underline decoration-cyan-500/20">Neural Config</h2>
                <div className="mb-8 space-y-4">
                  <p className="text-[10px] text-zinc-500 text-center uppercase leading-relaxed tracking-tighter font-bold">Access token required for neural speech processing</p>
                  <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="block w-full py-4 bg-zinc-900 border border-zinc-800 text-cyan-400 text-[10px] text-center rounded-xl font-black uppercase hover:bg-zinc-800 transition-all border-b-2 border-b-cyan-900/50">
                    GET API KEY <ExternalLink size={12} className="inline ml-1 mb-1" />
                  </a>
                </div>
                <div className="space-y-4">
                  <input type="password" value={localKey} onChange={(e) => { setLocalKey(e.target.value); localStorage.setItem('mimo_key', e.target.value); }} placeholder="Paste Neural Token..." className="w-full bg-zinc-900 border border-zinc-800 rounded-2xl px-6 py-5 text-sm text-white outline-none focus:border-cyan-500 transition-colors shadow-inner" />
                  <button onClick={() => { setIsBypassed(false); preloadAssets(localKey); setShowSettings(false); }} className="w-full bg-cyan-600 text-white py-5 rounded-2xl text-[11px] font-black uppercase tracking-[0.2em] hover:bg-cyan-500 shadow-lg shadow-cyan-900/20 active:scale-95 transition-all">Save & Sync Brain</button>
                </div>
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
};

const Eye = ({ mood, isAsleep, isSpeaking }) => (
  <div className={`w-40 h-40 md:w-56 md:h-56 bg-zinc-900/20 rounded-[45px] md:rounded-[60px] p-10 flex items-center justify-center border border-zinc-800/10 transition-all duration-200 ${isSpeaking ? 'filter drop-shadow(0 0 10px rgba(34,211,238,0.3))' : ''}`}>
    <div className="w-full h-full flex items-center justify-center">
      {isAsleep ? <div className="w-full h-3 bg-cyan-500/70 rounded-full shadow-[0_0_20px_rgba(6,182,212,0.6)] power-pulse" /> : 
       mood === 'angry' ? <div className="w-full h-full bg-cyan-400 shadow-[0_0_20px_rgba(34,211,238,0.8)]" style={{ clipPath: 'polygon(0% 45%, 100% 15%, 100% 100%, 0% 100%)' }} /> :
       mood === 'happy' ? <svg viewBox="0 0 100 100" className="w-full h-full fill-cyan-400 drop-shadow-[0_0_15px_rgba(34,211,238,0.8)]"><path d="M10,65 C20,30 80,30 90,65 L90,80 C80,45 20,45 10,80 Z" /></svg> :
       <div className={`w-full h-full bg-cyan-400 rounded-[28px] shadow-[0_0_40px_rgba(6,182,212,0.7)] ${isSpeaking ? 'animate-pulse' : ''}`} />}
    </div>
  </div>
);

export default App;

